<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="./popup.css"> -->
    <!-- <script defer src="/js/popup.js"></script> -->
     <style>
        body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: black;
    color: white; /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */
}
.comment-form {
    margin-bottom: 20px;
    position: relative;
}
.comment-form input {
    width: 80%; /* ê°€ë¡œ ê¸¸ì´ë¥¼ 80%ë¡œ ì„¤ì • */
    padding: 10px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
}
.char-counter {
    position: absolute;
    left: 78%; /* ìˆ«ìë¥¼ ì¢€ ë” ì¢Œì¸¡ìœ¼ë¡œ ì´ë™ */
    bottom: 15px;
    color: gray;
    font-size: 12px;
}
.comment-form button {
    padding: 10px 20px;
    border: none;
    background-color: rgb(174, 35, 27);
    color: white;
    border-radius: 5px;
    cursor: pointer;
}
.comment-form button:hover {
    background-color: rgb(200, 50, 50);
}
.comment {
    border-bottom: 1px solid #ccc;
    padding: 10px 0;
}
.comment-header {
    display: flex;
    justify-content: space-between;
}
.comment-body {
    margin: 10px 0;
    color: white; /* ëŒ“ê¸€ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */
}
.comment-footer {
    display: flex;
    align-items: center;
}
.likes {
    margin-right: 10px;
}
.comment-action {
    cursor: pointer;
    color: rgb(174, 35, 27);
}

     </style>
    <title>Comment Popup</title>
</head>
<body>
    <h2>ëŒ“ê¸€ ë‚´ìš©</h2>
    <div class="comment-form">
        <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
        <span class="char-counter" id="char-counter">0</span>
        <button id="add-comment">ì¶”ê°€</button>
    </div>
    <div id="comments-container">
        <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->

    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const commentInput = document.getElementById('comment-input');
        const addCommentButton = document.getElementById('add-comment');
        const commentsContainer = document.getElementById('comments-container');
        const charCounter = document.getElementById('char-counter');
        const comments = <%- JSON.stringify(comments) %>;
        const user = <%- JSON.stringify(user) %>;

        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateCharCount = () => {
            charCounter.textContent = commentInput.value.length;
        };

        // ì…ë ¥ì´ ë³€ê²½ë  ë•Œ ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        commentInput.addEventListener('input', updateCharCount);

        // ëŒ“ê¸€ ìƒì„±
        const createComment = (comment) => {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.dataset.id = comment.comment_id;

            const commentHeader = document.createElement('div');
            commentHeader.className = 'comment-header';

            const commentAuthor = document.createElement('div');
            commentAuthor.className = 'comment-author';
            commentAuthor.textContent = comment.User ? comment.User.nickname : 'ìµëª…';

            const commentOptions = document.createElement('div');
            commentOptions.className = 'comment-options';

            if (user && user.userId == comment.userid) {
                const editButton = document.createElement('button');
                editButton.textContent = 'ìˆ˜ì •';
                editButton.addEventListener('click', () => {
                    editComment(commentDiv);
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ì‚­ì œ';
                deleteButton.addEventListener('click', () => {
                    deleteComment(commentDiv);
                });

                commentOptions.appendChild(editButton);
                commentOptions.appendChild(deleteButton);
            }

            commentHeader.appendChild(commentAuthor);
            commentHeader.appendChild(commentOptions);

            const commentBody = document.createElement('div');
            commentBody.className = 'comment-body';
            commentBody.textContent = comment.comment_contents;

            const commentFooter = document.createElement('div');
            commentFooter.className = 'comment-footer';

            const likesSpan = document.createElement('span');
            likesSpan.className = 'likes';
            likesSpan.textContent = '0';

            const likeButton = document.createElement('span');
            likeButton.className = 'comment-action';
            likeButton.innerHTML = 'ì¢‹ì•„ìš” <span class="thumb">ğŸ‘</span>';
            likeButton.addEventListener('click', (event) => {
                if (event.target.classList.contains('thumb')) {
                    likesSpan.textContent = '0';
                } else {
                    let likes = parseInt(likesSpan.textContent);
                    likes++;
                    likesSpan.textContent = likes;
                }
            });

            commentFooter.appendChild(likesSpan);
            commentFooter.appendChild(likeButton);

            commentDiv.appendChild(commentHeader);
            commentDiv.appendChild(commentBody);
            commentDiv.appendChild(commentFooter);

            commentsContainer.appendChild(commentDiv);
        };

        // ëŒ“ê¸€ ìˆ˜ì •
        const editComment = (comment) => {
            const commentBody = comment.querySelector('.comment-body');
            const newText = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:', commentBody.textContent);
            if (newText) {
                fetch(`/comment/edit/${comment.dataset.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment_contents: newText })
                }).then(response => {
                    if (response.ok) {
                        commentBody.textContent = newText;
                    } else {
                        alert('Failed to edit comment.');
                    }
                });
            }
        };

        // ëŒ“ê¸€ ì‚­ì œ
        const deleteComment = (comment) => {
            if (confirm('Are you sure you want to delete this comment?')) {
                fetch(`/comment/delete/${comment.dataset.id}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        commentsContainer.removeChild(comment);
                    } else {
                        alert('Failed to delete comment.');
                    }
                });
            }
        };

        // ëŒ“ê¸€ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        addCommentButton.addEventListener('click', () => {
            const text = commentInput.value.trim();
            if (!user) {
                alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”');
                commentInput.value = '';
                return;
            }
            if (text) {
                fetch('/comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment_contents: text })
                }).then(response => {
                    if (response.ok) {
                        response.json().then(newComment => {
                            createComment(newComment);
                        });
                        commentInput.value = '';
                        updateCharCount(); // ëŒ“ê¸€ì´ ì¶”ê°€ë˜ë©´ ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
                    } else {
                        alert('Failed to post comment.');
                    }
                }).catch(error => {
                    console.error('Error posting comment:', error);
                    alert('Failed to post comment.');
                });
            } else {
                alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
            }
        });

        // ì„œë²„ì—ì„œ ëŒ“ê¸€ ë°ì´í„° ë¡œë“œ
        comments.forEach(comment => {
            createComment(comment);
        });

        // ì´ˆê¸° ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        updateCharCount();
    });
</script>
</html>
